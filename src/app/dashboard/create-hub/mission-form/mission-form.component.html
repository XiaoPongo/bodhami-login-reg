<div class="form-container">

    <!-- SUCCESS VIEW -->
    <div *ngIf="isSubmitted" class="success-view">
      <i class="fas fa-check-circle"></i>
      <h2>Mission Created Successfully!</h2>
      <p>Your new mission has been saved. You can export the data for debugging or return to the dashboard.</p>
      <div class="success-actions">
        <button type="button" class="btn btn-primary" (click)="resetForm()"><i class="fas fa-plus"></i> Create Another Mission</button>
        <button type="button" class="btn btn-secondary" (click)="exportToCsv()"><i class="fas fa-download"></i> Export to CSV</button>
        <button type="button" class="btn btn-secondary" (click)="navigateToDashboard()"><i class="fas fa-tachometer-alt"></i> Return to Dashboard</button>
      </div>
    </div>
  
    <!-- FORM & PREVIEW CONTAINER -->
    <div *ngIf="!isSubmitted">
      <h2>{{ isPreviewing ? 'Mission Preview' : 'Create Mission' }}</h2>
  
      <!-- PREVIEW MODE -->
      <div *ngIf="isPreviewing" class="preview-container">
        <div class="preview-section">
          <h3>{{ mission.title || 'Untitled Mission' }}</h3>
          <span class="preview-xp-badge">{{ mission.xp }} XP</span>
        </div>
        <div class="preview-section">
          <h4>Description</h4>
          <p>{{ mission.description || 'No description provided.' }}</p>
        </div>
        <div class="preview-section" *ngIf="mission.passages.length > 0 && mission.passages[0]">
          <h4>Passages</h4>
          <div *ngFor="let passage of mission.passages; let i = index" class="preview-item"><strong>Passage {{i + 1}}:</strong> {{ passage }}</div>
        </div>
        <div class="preview-section">
          <h4>Scenarios</h4>
          <div *ngFor="let scenario of mission.scenarios; let i = index" class="preview-item">
            <strong>Scenario {{i + 1}}:</strong> {{ scenario.question }}
            <ul class="preview-answer-list">
              <li *ngIf="scenario.type === 'qa' || scenario.type === 'fib'"><strong>Answers:</strong> {{ scenario.answers.join(', ') }}</li>
              <li *ngIf="scenario.type === 'mcq'" *ngFor="let option of scenario.options; let j = index">
                {{ j === scenario.correctMcqIndex ? '✔️' : '⚪' }} {{ option.text }}
              </li>
            </ul>
          </div>
        </div>
        <div class="form-actions">
          <button type="button" class="btn btn-secondary" (click)="togglePreview()"><i class="fas fa-edit"></i> Back to Edit</button>
        </div>
      </div>
  
      <!-- EDIT MODE -->
      <form *ngIf="!isPreviewing" #missionForm="ngForm" (ngSubmit)="onSubmit()">
        
        <div class="guidelines-box">
          <i class="fas fa-info-circle"></i>
          <div>
            <strong>Quick Guide:</strong>
            <p>Start with a title, build content with passages and scenarios (choosing a question type for each), then assign to classes.</p>
          </div>
        </div>
  
        <div class="upload-section">
          <label for="csvUpload" class="btn btn-upload"><i class="fas fa-file-csv"></i> Have a CSV? Upload here to auto-fill</label>
          <input type="file" id="csvUpload" (change)="onFileSelected($event)" accept=".csv" hidden>
        </div>
  
        <div class="form-section">
          <div class="section-header"><h3><i class="fas fa-info-circle"></i> Basic Information</h3></div>
          <div class="form-group">
            <label for="title">Mission Title *</label>
            <input type="text" id="title" name="title" [(ngModel)]="mission.title" required>
          </div>
          <div class="form-group">
            <label for="description">Mission Description</label>
            <textarea id="description" name="description" rows="3" [(ngModel)]="mission.description"></textarea>
          </div>
          <div class="form-group">
            <label for="xp">XP Allotment</label>
            <input type="number" id="xp" name="xp" [(ngModel)]="mission.xp" required min="0">
          </div>
        </div>
        
        <div class="form-section">
          <div class="section-header"><h3><i class="fas fa-file-alt"></i> Content Builder</h3></div>
          <div class="form-group">
            <label>Passages</label>
            <div *ngFor="let passage of mission.passages; let i = index; trackBy: trackByFn" class="dynamic-input">
              <textarea [name]="'passage' + i" [(ngModel)]="mission.passages[i]" placeholder="Passage {{i + 1}}" rows="2"></textarea>
              <button type="button" class="btn-remove" (click)="removePassage(i)" title="Remove Passage">&times;</button>
            </div>
            <button type="button" class="btn-add" (click)="addPassage()"><i class="fas fa-plus"></i> Add Passage</button>
          </div>
          
          <div class="form-group">
            <label>Scenarios</label>
            <div *ngFor="let scenario of mission.scenarios; let i = index; trackBy: trackByFn" class="dynamic-group">
              <div class="question-type-selector">
                <label [for]="'type' + i">Question Type</label>
                <select [name]="'type' + i" [(ngModel)]="scenario.type" (change)="onQuestionTypeChange(i, $any($event.target).value)">
                  <option value="qa">Question & Answer</option>
                  <option value="mcq">Multiple Choice</option>
                  <option value="fib">Fill in the Blanks</option>
                </select>
              </div>
              <div class="form-group">
                <label [for]="'question' + i">Question / Sentence *</label>
                <textarea [name]="'question' + i" [(ngModel)]="scenario.question" placeholder="For FIB, use '___' for the blank(s)" required rows="2"></textarea>
              </div>
  
              <div *ngIf="scenario.type === 'qa'" class="answer-section">
                <label>Correct Answers</label>
                <div *ngFor="let answer of scenario.answers; let j = index; trackBy: trackByFn" class="dynamic-input">
                  <input type="text" [name]="'answer' + i + '-' + j" [(ngModel)]="scenario.answers[j]" placeholder="Answer {{j + 1}}">
                  <button type="button" class="btn-remove" (click)="removeAnswer(i, j)">&times;</button>
                </div>
                <button type="button" class="btn-add" (click)="addAnswer(i)"><i class="fas fa-plus"></i> Add Answer</button>
              </div>
              
              <div *ngIf="scenario.type === 'fib'" class="answer-section">
                <label>Word(s) for the Blank(s)</label>
                <div *ngFor="let answer of scenario.answers; let j = index; trackBy: trackByFn" class="dynamic-input">
                  <input type="text" [name]="'fib-answer' + i + '-' + j" [(ngModel)]="scenario.answers[j]" placeholder="Correct word {{j + 1}}">
                  <button type="button" class="btn-remove" (click)="removeAnswer(i, j)">&times;</button>
                </div>
                <button type="button" class="btn-add" (click)="addAnswer(i)"><i class="fas fa-plus"></i> Add Word</button>
              </div>
  
              <div *ngIf="scenario.type === 'mcq'" class="answer-section">
                <label>Options (select the correct one)</label>
                <div *ngFor="let option of scenario.options; let j = index; trackBy: trackByFn" class="dynamic-input mcq-option">
                  <input type="radio" [name]="'correctMcq' + i" [value]="j" [(ngModel)]="scenario.correctMcqIndex">
                  <input type="text" [name]="'mcqOption' + i + '-' + j" [(ngModel)]="option.text" placeholder="Option {{j + 1}}">
                  <button type="button" class="btn-remove" (click)="removeMcqOption(i, j)">&times;</button>
                </div>
                <button type="button" class="btn-add" (click)="addMcqOption(i)"><i class="fas fa-plus"></i> Add Option</button>
              </div>
              
              <div class="dynamic-controls">
                <button type="button" class="btn-remove-group" (click)="removeScenario(i)"><i class="fas fa-trash-alt"></i> Remove Scenario</button>
              </div>
            </div>
            <button type="button" class="btn-add" (click)="addScenario()"><i class="fas fa-plus"></i> Add Scenario</button>
          </div>
        </div>
        
        <div class="form-section">
          <div class="section-header"><h3><i class="fas fa-chalkboard-teacher"></i> Class Assignment</h3></div>
          <label>Assign to Classes *</label>
          <div class="class-selection-container">
            <div *ngFor="let class of availableClasses" class="class-item">
              <input type="checkbox" [id]="'class-' + class.id" [value]="class.id" (change)="onClassChange($event)" [checked]="mission.classIds.includes(class.id)">
              <label [for]="'class-' + class.id">{{ class.name }}</label>
            </div>
          </div>
        </div>
  
        <div class="form-actions">
          <button type="button" class="btn btn-secondary" (click)="togglePreview()"><i class="fas fa-eye"></i> Preview</button>
          <button type="submit" class="btn btn-primary" [disabled]="missionForm.invalid || mission.classIds.length === 0"><i class="fas fa-paper-plane"></i> Submit Mission</button>
        </div>
      </form>
    </div>
  </div>  
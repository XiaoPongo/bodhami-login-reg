<div class="container">
  <!-- Notification Banner -->
  <div *ngIf="notification" class="notification-banner" [ngClass]="notification.type">
    <i [class]="notification.type === 'success' ? 'fas fa-check-circle' : 'fas fa-exclamation-triangle'"></i>
    <span>{{ notification.message }}</span>
  </div>

  <!-- File Upload Hub -->
  <div class="upload-hub">
    <div class="upload-step">
      <div class="step-number">1</div>
      <div class="step-content">
        <label for="class-target">Select a Class to Upload To</label>
        <select id="class-target" [(ngModel)]="uploadTargetClassId">
          <option value="" disabled selected>-- Choose a class --</option>
          <option *ngFor="let class of (classes$ | async)" [value]="class.id">{{ class.name }}</option>
        </select>
      </div>
    </div>
    <div 
      class="upload-step drop-zone-wrapper"
      (dragover)="onDragOver($event)"
      (dragleave)="onDragLeave($event)"
      (drop)="onDrop($event)"
      [class.dragging]="isDragging"
      [class.disabled]="!uploadTargetClassId">
      <div class="step-number">2</div>
      <div class="step-content drop-zone">
          <i class="fas fa-cloud-upload-alt"></i>
          <h3>Drag & drop files or click to browse</h3>
          <p>Allowed: .pdf, .docx, .csv, .xlsx (Max 5MB)</p>
          <input id="file-upload" type="file" (change)="onFileSelected($event)" multiple accept=".pdf,.docx,.csv,.xlsx" [disabled]="!uploadTargetClassId" title="Select files to upload">
      </div>
    </div>
  </div>

  <!-- Upload Queue Section -->
  <div class="upload-queue" *ngIf="filesToUpload.length > 0">
    <h4>Upload Queue</h4>
    <div *ngFor="let item of filesToUpload; let i = index" class="upload-item" [ngClass]="item.status">
      <div class="file-icon"><i [class]="getFileTypeIcon(item.file.name)"></i></div>
      <div class="file-details">
        <span class="file-name">{{ item.file.name }}</span>
        <div class="progress-bar-container" *ngIf="item.status === 'uploading'">
          <div class="progress-bar" [style.width.%]="item.progress"></div>
          <span class="progress-text">{{ item.progress }}%</span>
        </div>
        <span class="status-text error" *ngIf="item.status === 'error'"><i class="fas fa-exclamation-circle"></i> {{ item.error }}</span>
        <span class="status-text success" *ngIf="item.status === 'success'"><i class="fas fa-check-circle"></i> Upload Complete!</span>
      </div>
      <button class="btn-remove" (click)="removeFileFromQueue(i)" title="Remove from queue">&times;</button>
    </div>
  </div>

  <!-- File Management Section -->
  <div class="management-section">
    <div class="management-header">
      <h2>Your Materials</h2>
      <div class="header-controls">
        <select [(ngModel)]="selectedClassFilter" (ngModelChange)="onFilterChange($event)">
          <option value="all">Filter by Class: All</option>
          <option value="unassigned">Unassigned</option>
          <option *ngFor="let class of (classes$ | async)" [value]="class.id">{{ class.name }}</option>
        </select>
        <button class="btn-icon" (click)="handleRefresh()" title="Refresh Materials">
          <i class="fas fa-sync-alt"></i>
        </button>
      </div>
    </div>
    
    <!-- Bulk Action Toolbar -->
    <div class="bulk-actions" *ngIf="showBulkToolbar">
        <span>{{ selectedFileIds.size }} file(s) selected</span>
        <div>
            <!-- THIS IS THE FIX: Removed the invalid [...] syntax -->
            <button class="btn btn-secondary" (click)="openAssignModal(selectedFileIds)"><i class="fas fa-plus-circle"></i> Assign to Class</button>
            <button class="btn-danger" (click)="openDeleteModal(selectedFileIds)"><i class="fas fa-trash-alt"></i> Delete Selected</button>
        </div>
    </div>

    <!-- Grid with Fallbacks -->
    <ng-container *ngIf="!(isLoading$ | async); else loading">
      <ng-container *ngIf="(filteredMaterials$ | async) as materials">
        <div *ngIf="materials.length > 0; else noMaterials" class="file-grid">
          <div *ngFor="let material of materials" class="file-card">
            <input type="checkbox" class="file-checkbox" (change)="toggleFileSelection(material.id, $event)">
            <div class="file-card-icon">
              <i [class]="getFileTypeIcon(material.displayName)"></i>
            </div>
            <div class="file-card-details">
              <span class="file-name" title="{{ material.displayName }}">{{ material.displayName }}</span>
              <span class="file-meta">
                {{ getClassNameById(material.classroom?.id) }}
              </span>
            </div>
            <div class="file-actions">
                <!-- THIS IS THE FIX: Removed the invalid [...] syntax -->
                <button (click)="openAssignModal(material.id)" title="Assign to a different class"><i class="fas fa-random"></i></button>
                <button (click)="openDeleteModal(material.id, material.displayName)" title="Delete Material"><i class="fas fa-trash"></i></button>
            </div>
          </div>
        </div>
        <ng-template #noMaterials>
          <div class="empty-grid-state">
            <i class="fas fa-folder-open"></i>
            <p>No materials found for this filter.</p>
          </div>
        </ng-template>
      </ng-container>
    </ng-container>

    <ng-template #loading>
      <div class="file-grid">
        <div class="file-card placeholder" *ngFor="let i of [1,2,3,4]"></div>
      </div>
    </ng-template>
  </div>
</div>

<!-- Universal Modal for Assigning -->
<div *ngIf="isAssignModalOpen" class="modal-overlay" (click)="clearSelection()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Assign {{ selectedFileIds.size }} Material(s)</h3>
      <button class="btn-close" (click)="clearSelection()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="input-group">
        <label for="assignClass">Select a Class</label>
        <select id="assignClass" [(ngModel)]="assignTargetClassId" name="assignTargetClassId">
          <option value="" disabled selected>-- Choose a class --</option>
          <option value="unassign">Unassign (make available to all)</option>
          <option *ngFor="let class of (classes$ | async)" [value]="class.id">{{ class.name }}</option>
        </select>
      </div>
      <div class="modal-actions">
        <button type="button" class="btn btn-secondary" (click)="clearSelection()">Cancel</button>
        <button type="button" class="btn btn-primary" (click)="confirmAssignment()" [disabled]="!assignTargetClassId">Confirm</button>
      </div>
    </div>
  </div>
</div>

<!-- Universal Confirmation Modal -->
<div *ngIf="confirmModal.isOpen" class="modal-overlay" (click)="closeConfirmModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
            <h3>{{ confirmModal.title }}</h3>
            <button class="btn-close" (click)="closeConfirmModal()">&times;</button>
        </div>
        <div class="modal-body">
            <p [innerHTML]="confirmModal.message"></p>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" (click)="closeConfirmModal()">Cancel</button>
                <button type="button" class="btn-danger" (click)="confirmModal.onConfirm()">Confirm</button>
            </div>
        </div>
    </div>
</div>


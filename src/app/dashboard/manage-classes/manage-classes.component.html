<div class="manage-container">
  <!-- Left Panel: Class List -->
  <div class="left-panel">
    <div class="panel-header">
      <div class="panel-title-group">
        <a routerLink="/mentor/dashboard" class="back-link" title="Back to Dashboard"><i class="fas fa-arrow-left"></i></a>
        <h2>Classrooms</h2>
      </div>
      <button class="btn btn-primary" (click)="openCreateModal()">
        <i class="fas fa-plus"></i> New Class
      </button>
    </div>
    <div class="class-list-scroll">
      <ng-container *ngIf="(classes$ | async) as classes; else loadingClasses">
        <div *ngIf="classes.length > 0; else noClasses">
          <div 
            *ngFor="let class of classes" 
            class="class-card"
            [class.selected]="(selectedClass$ | async)?.id === class.id"
            (click)="handleSelectClass(class.id)">
            <div class="class-card-header">
              <span class="class-name">{{ class.name }}</span>
              <span class="class-code">{{ class.classCode }}</span>
            </div>
            <p class="class-description">{{ class.description | slice:0:100 }}{{ class.description.length > 100 ? '...' : '' }}</p>
            <div class="class-card-footer">
              <span><i class="fas fa-users"></i> {{ class.students.length ?? 0 }}</span>
              <span><i class="fas fa-file-alt"></i> {{ (class.materials.length ?? 0) + (class.activities.length ?? 0) }}</span>
            </div>
          </div>
        </div>
        <ng-template #noClasses>
          <div class="empty-state">
            <p>No classes yet. <br> Click "New Class" to start.</p>
          </div>
        </ng-template>
      </ng-container>
      <ng-template #loadingClasses>
        <div class="class-card placeholder" *ngFor="let i of [1,2,3]"></div>
      </ng-template>
    </div>
  </div>

  <!-- Right Panel: Class Details -->
  <div class="right-panel">
    <ng-container *ngIf="!(isLoading$ | async); else classLoading">
      <ng-container *ngIf="(selectedClass$ | async) as selectedClass; else noClassSelected">
        <!-- VIEW MODE -->
        <div class="detail-header" *ngIf="!isEditingClass">
          <div>
            <h1>{{ selectedClass.name }}</h1>
            <p>{{ selectedClass.description || 'No description provided.' }}</p>
          </div>
          <div class="header-actions">
            <div class="code-box" (click)="copyCode(selectedClass.classCode)" title="Copy Join Code">
              <span>{{ selectedClass.classCode }}</span>
              <i class="fas fa-copy"></i>
            </div>
            <button class="btn btn-secondary" (click)="handleEditClass(selectedClass)"><i class="fas fa-pencil-alt"></i> Edit</button>
            <button class="btn btn-danger" (click)="handleDeleteClass(selectedClass.id, selectedClass.name)">
              <i class="fas fa-trash"></i> Delete
            </button>
          </div>
        </div>
        
        <!-- EDIT MODE -->
        <div class="detail-header-edit" *ngIf="isEditingClass">
            <div class="input-group-edit">
              <input type="text" class="h1-input" [(ngModel)]="editableClassName" placeholder="Class Name">
              <textarea class="p-input" [(ngModel)]="editableClassDescription" placeholder="Class Description" rows="2"></textarea>
            </div>
            <div class="header-actions">
              <button class="btn btn-secondary" (click)="handleCancelEdit()">Cancel</button>
              <button class="btn btn-primary" (click)="handleSaveClass(selectedClass.id)" [disabled]="!editableClassName.trim()">Save</button>
            </div>
        </div>

        <!-- Content Tabs -->
        <div class="content-tabs">
          <button [class.active]="activeContentTab === 'students'" (click)="setActiveTab('students')">
            <i class="fas fa-users"></i> Enrolled Students ({{ selectedClass.students.length ?? 0 }})
          </button>
          <button [class.active]="activeContentTab === 'materials'" (click)="setActiveTab('materials')">
            <i class="fas fa-folder-open"></i> Materials ({{ selectedClass.materials.length ?? 0 }})
          </button>
          <button [class.active]="activeContentTab === 'activities'" (click)="setActiveTab('activities')">
            <i class="fas fa-gamepad"></i> Activities ({{ selectedClass.activities.length ?? 0 }})
          </button>
        </div>

        <!-- Tab Content -->
        <div class="tab-content">
          <!-- Students Tab -->
          <div *ngIf="activeContentTab === 'students'">
            <div class="content-table-wrapper" *ngIf="selectedClass.students.length > 0; else emptyContent">
              <table class="content-table">
                <thead>
                  <tr>
                    <th>Student</th><th>XP</th><th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let student of selectedClass.students">
                    <td>
                      <div>
                        <span class="student-name">{{ student.name }}</span>
                        <span class="student-email">{{ student.email }}</span>
                      </div>
                    </td>
                    <td>{{ student.xp }}</td>
                    <td>
                      <button class="btn-icon btn-danger-outline" title="Remove Student" (click)="handleRemoveStudent(selectedClass.id, student)">
                        <i class="fas fa-user-minus"></i>
                      </button>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
          <!-- Materials Tab -->
          <div *ngIf="activeContentTab === 'materials'">
             <div class="content-table-wrapper" *ngIf="selectedClass.materials.length > 0; else emptyContent">
              <table class="content-table">
                <thead>
                  <tr>
                    <th>Display Name</th><th>File Type</th><th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let material of selectedClass.materials">
                    <td><i class="fas fa-file-alt"></i> {{ material.displayName }}</td><td>{{ material.fileType }}</td>
                    <td>
                      <button class="btn-icon btn-danger-outline" title="Unassign Material" (click)="handleUnassignMaterial(selectedClass.id, material)">
                        <i class="fas fa-unlink"></i>
                      </button>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
          <!-- Activities Tab -->
          <div *ngIf="activeContentTab === 'activities'">
            <div class="content-table-wrapper" *ngIf="selectedClass.activities.length > 0; else emptyContent">
              <table class="content-table">
                <thead>
                  <tr>
                    <th>Title</th><th>Type</th><th>XP</th><th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let activity of selectedClass.activities">
                    <td><i class="fas fa-gamepad"></i> {{ activity.title }}</td><td>{{ activity.type }}</td><td>{{ activity.xp }}</td>
                    <td>
                      <button class="btn-icon btn-danger-outline" title="Unassign Activity" (click)="handleUnassignActivity(selectedClass.id, activity)">
                         <i class="fas fa-unlink"></i>
                      </button>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </ng-container>
      
      <ng-template #noClassSelected>
        <div class="empty-state-large">
          <i class="fas fa-mouse-pointer"></i>
          <h2>Select a Class</h2>
          <p>Choose a class from the list to view its details or create a new one.</p>
        </div>
      </ng-template>
    </ng-container>

    <ng-template #classLoading>
      <div class="loading-skeleton">
        <div class="skeleton-header">
          <div style="flex-grow: 1;">
            <div class="skeleton-box skeleton-title"></div>
            <div class="skeleton-box skeleton-line" style="width: 70%; margin-top: 0.5rem; height: 16px;"></div>
          </div>
          <div class="skeleton-actions">
            <div class="skeleton-box skeleton-button"></div>
            <div class="skeleton-box skeleton-button"></div>
          </div>
        </div>
        <div class="skeleton-tabs">
          <div class="skeleton-box skeleton-tab"></div>
          <div class="skeleton-box skeleton-tab"></div>
          <div class="skeleton-box skeleton-tab"></div>
        </div>
        <div class="skeleton-box skeleton-line" style="height: 40px;"></div>
        <div class="skeleton-box skeleton-line" style="height: 40px; margin-top: 1rem;"></div>
        <div class="skeleton-box skeleton-line" style="height: 40px; margin-top: 1rem;"></div>
      </div>
    </ng-template>

    <ng-template #emptyContent>
      <div class="placeholder-text">
        <i class="fas fa-box-open"></i>
        <h3>Nothing to see here yet.</h3>
        <p>This section is currently empty.</p>
      </div>
    </ng-template>
  </div>
</div>

<!-- Modal for creating a new class -->
<div *ngIf="isCreateModalOpen" class="modal-overlay" (click)="closeCreateModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Create New Class</h3>
      <button class="btn-close" (click)="closeCreateModal()">&times;</button>
    </div>
    <div class="modal-body">
      <form #createClassForm="ngForm" (ngSubmit)="handleCreateClass()">
        <div class="input-group">
          <label for="newClassName">Class Name *</label>
          <input type="text" id="newClassName" [(ngModel)]="newClassName" name="newClassName" required>
        </div>
        <div class="input-group">
          <label for="newClassDescription">Description</label>
          <textarea id="newClassDescription" [(ngModel)]="newClassDescription" name="newClassDescription" rows="4"></textarea>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" (click)="closeCreateModal()">Cancel</button>
          <button type="submit" class="btn btn-primary" [disabled]="!createClassForm.form.valid">Create Class</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Generic Confirmation Modal -->
<div *ngIf="confirmModal.isOpen" class="modal-overlay">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>{{ confirmModal.title }}</h3>
    </div>
    <div class="modal-body">
      <p [innerHTML]="confirmModal.message"></p>
      <div class="modal-actions">
        <button type="button" class="btn btn-secondary" (click)="closeConfirmModal()">Cancel</button>
        <button type="button" class="btn btn-danger" (click)="confirmModal.onConfirm()">Confirm</button>
      </div>
    </div>
  </div>
</div>

<!-- Toast Notification -->
<div class="toast-notification" [class.show]="toast.isVisible">
  <p>{{ toast.message }}</p>
</div>


<div class="manage-classes-container">
  <!-- Left Panel: List of all classes -->
  <div class="left-panel">
    <div class="panel-header">
      <h2>All Classes</h2>
      <button class="btn btn-primary" (click)="openCreateModal()">
        <i class="fas fa-plus"></i> Create Class
      </button>
    </div>
    <div class="class-list">
      <div *ngIf="classes.length === 0" class="empty-state">
        <i class="fas fa-school"></i>
        <p>No classes found.</p>
        <span>Click "Create Class" to get started.</span>
      </div>
      <div 
        *ngFor="let class of classes" 
        class="class-item" 
        [class.selected]="class.id === selectedClass?.id"
        (click)="selectClass(class)">
        <div class="class-item-header">
          <span class="class-name">{{ class.name }}</span>
          <span class="class-code">Code: {{ class.classCode }}</span>
        </div>
        <div class="class-item-footer">
          <!-- FIX: Use optional chaining (?.) and nullish coalescing (?? 0) -->
          <span class="student-count">{{ class.students?.length ?? 0 }} Students</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Right Panel: Details of the selected class -->
  <div class="right-panel">
    <!-- View when no class is selected -->
    <div *ngIf="!selectedClass" class="empty-state-large">
      <i class="fas fa-mouse-pointer"></i>
      <h2>Select a Class</h2>
      <p>Choose a class from the list on the left to view its details and manage students.</p>
    </div>

    <!-- View when a class IS selected -->
    <div *ngIf="selectedClass" class="class-details">
      <div class="detail-header">
        <button class="btn-back" (click)="unselectClass()">
          <i class="fas fa-arrow-left"></i> Back to List
        </button>
        <h2>{{ selectedClass.name }}</h2>
        <p class="description">{{ selectedClass.description }}</p>
        <div class="code-container">
          <span>Class Code:</span>
          <div class="code-box" (click)="copyCode(selectedClass.classCode)" title="Copy Code">
            <strong>{{ selectedClass.classCode }}</strong>
            <i class="fas fa-copy"></i>
          </div>
        </div>
      </div>

      <div class="student-management">
        <div class="student-list-header">
          <!-- FIX: Use optional chaining (?.) and nullish coalescing (?? 0) -->
          <h4>Enrolled Students ({{ selectedClass.students?.length ?? 0 }})</h4>
          <button class="btn btn-secondary" (click)="openAddStudentModal()">
            <i class="fas fa-user-plus"></i> Add Student
          </button>
        </div>
        
        <!-- Empty state for students -->
        <div *ngIf="!(selectedClass.students && selectedClass.students.length > 0)" class="empty-state small">
          <p>No students have been enrolled in this class yet.</p>
        </div>

        <!-- Student Table -->
        <table *ngIf="selectedClass.students && selectedClass.students.length > 0" class="student-table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Email</th>
              <th>XP</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <!-- FIX: Safely loop over students, providing an empty array as a fallback -->
            <tr *ngFor="let student of selectedClass.students ?? []">
              <td>{{ student.name }}</td>
              <td>{{ student.email }}</td>
              <td>{{ student.xp }}xp</td>
              <td>
                <button class="btn-remove" (click)="handleRemoveStudent(student.id)" title="Remove Student">
                  <i class="fas fa-trash-alt"></i>
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Modal for creating a new class -->
<div *ngIf="isCreateModalOpen" class="modal-overlay" (click)="closeCreateModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Create New Class</h3>
      <button class="btn-close" (click)="closeCreateModal()">&times;</button>
    </div>
    <div class="modal-body">
      <form #createClassForm="ngForm" (ngSubmit)="handleCreateClass()">
        <div class="input-group">
          <label for="newClassName">Class Name</label>
          <input type="text" id="newClassName" [(ngModel)]="newClassName" name="newClassName" required>
        </div>
        <div class="input-group">
          <label for="newClassDescription">Description</label>
          <textarea id="newClassDescription" [(ngModel)]="newClassDescription" name="newClassDescription" rows="4"></textarea>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" (click)="closeCreateModal()">Cancel</button>
          <button type="submit" class="btn btn-primary" [disabled]="!newClassName.trim()">Create</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal for adding a new student -->
<div *ngIf="isAddStudentModalOpen" class="modal-overlay" (click)="closeAddStudentModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Add Student to {{ selectedClass?.name }}</h3>
      <button class="btn-close" (click)="closeAddStudentModal()">&times;</button>
    </div>
    <div class="modal-body">
      <form #addStudentForm="ngForm" (ngSubmit)="handleAddStudent()">
        <div class="input-group">
            <label for="studentName">Student Name</label>
            <input type="text" id="studentName" [(ngModel)]="newStudentName" name="studentName" required>
        </div>
        <div class="input-group">
          <label for="studentEmail">Student Email</label>
          <input type="email" id="studentEmail" [(ngModel)]="newStudentEmail" name="studentEmail" required email>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" (click)="closeAddStudentModal()">Cancel</button>
          <button type="submit" class="btn btn-primary" [disabled]="!newStudentName.trim() || !newStudentEmail.trim()">Add Student</button>
        </div>
      </form>
    </div>
  </div>
</div>
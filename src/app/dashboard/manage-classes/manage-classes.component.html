<!-- THIS IS THE FIX: The main container now has a relative position -->
<!-- to properly contain absolutely positioned children like the toast. -->
<div class="manage-container" style="position: relative;">

  <!-- Left Panel: Class List -->
  <div class="left-panel">
    <div class="panel-header">
      <a routerLink="/mentor/dashboard" class="back-link">
        <i class="fas fa-arrow-left"></i> Classrooms
      </a>
      <button class="btn btn-primary" (click)="openCreateModal()">
        <i class="fas fa-plus"></i> New Class
      </button>
    </div>
    <div class="class-list-scroll">
      <ng-container *ngIf="(isLoading$ | async); else classContent">
        <!-- Loading Skeletons -->
        <div class="class-card placeholder" *ngFor="let i of [1,2,3]"></div>
      </ng-container>

      <ng-template #classContent>
        <ng-container *ngIf="(classes$ | async) as classes">
          <div *ngIf="classes.length > 0; else noClasses">
            <div 
              *ngFor="let class of classes" 
              class="class-card"
              [class.selected]="(selectedClass$ | async)?.id === class.id"
              (click)="handleSelectClass(class.id)">
              <div class="class-card-header">
                <span class="class-name">{{ class.name }}</span>
                <span class="class-code">{{ class.classCode }}</span>
              </div>
              <p class="class-description">{{ (class.description | slice:0:100) || 'No description provided.' }}{{ class.description && class.description.length > 100 ? '...' : '' }}</p>
              <div class="class-card-footer">
                <span><i class="fas fa-users"></i> {{ class.students.length ?? 0 }}</span>
                <span><i class="fas fa-file-alt"></i> {{ (class.materials.length ?? 0) + (class.activities.length ?? 0) }}</span>
              </div>
            </div>
          </div>
          <ng-template #noClasses>
            <div class="empty-state">
              <p>No classes yet. <br> Click "New Class" to start.</p>
            </div>
          </ng-template>
        </ng-container>
      </ng-template>
    </div>
  </div>

  <!-- Right Panel: Class Details -->
  <div class="right-panel">
    <!-- THIS IS THE FIX: All access to 'selectedClass' is now inside this container. -->
    <!-- This prevents the 'cannot read properties of null' error. -->
    <ng-container *ngIf="(selectedClass$ | async) as selectedClass; else noClassSelected">
      
      <!-- View/Edit Header -->
      <ng-container *ngIf="!isEditingClass; else editHeader">
        <div class="detail-header">
          <div>
            <h1>{{ selectedClass.name }}</h1>
            <p>{{ selectedClass.description || 'No description provided.' }}</p>
          </div>
          <div class="header-actions">
            <div class="code-box" (click)="copyCode(selectedClass.classCode)" title="Copy Join Code">
              <span>{{ selectedClass.classCode }}</span> <i class="fas fa-copy"></i>
            </div>
            <button class="btn btn-secondary" (click)="handleEditClass(selectedClass)">
              <i class="fas fa-edit"></i> Edit
            </button>
            <button class="btn btn-danger" (click)="handleDeleteClass(selectedClass.id, selectedClass.name)">
              <i class="fas fa-trash"></i> Delete
            </button>
          </div>
        </div>
      </ng-container>

      <!-- Edit State Header -->
      <ng-template #editHeader>
        <div class="edit-header-form">
          <div class="input-group">
            <label for="editableClassName">Class Name *</label>
            <input type="text" id="editableClassName" [(ngModel)]="editableClassName" name="editableClassName" required>
          </div>
          <div class="input-group">
            <label for="editableClassDescription">Description</label>
            <textarea id="editableClassDescription" [(ngModel)]="editableClassDescription" name="editableClassDescription" rows="2"></textarea>
          </div>
          <div class="header-actions">
            <button class="btn btn-secondary" (click)="handleCancelEdit()">Cancel</button>
            <button class="btn btn-primary" [disabled]="!editableClassName.trim()" (click)="handleSaveClass(selectedClass.id)">
              <i class="fas fa-save"></i> Save Changes
            </button>
          </div>
        </div>
      </ng-template>

      <!-- Content Tabs -->
      <div class="content-tabs">
        <button [class.active]="activeContentTab === 'students'" (click)="setActiveTab('students')">
          <i class="fas fa-users"></i> Enrolled Students ({{ selectedClass.students.length }})
        </button>
        <button [class.active]="activeContentTab === 'materials'" (click)="setActiveTab('materials')">
          <i class="fas fa-folder-open"></i> Materials ({{ selectedClass.materials.length }})
        </button>
        <button [class.active]="activeContentTab === 'activities'" (click)="setActiveTab('activities')">
          <i class="fas fa-gamepad"></i> Activities ({{ selectedClass.activities.length }})
        </button>
      </div>

      <!-- Tab Content -->
      <div class="tab-content">
        <!-- Students Tab -->
        <div *ngIf="activeContentTab === 'students'">
          <div class="table-wrapper" *ngIf="selectedClass.students.length > 0; else emptyContent">
            <table class="content-table">
              <thead><tr><th>Full Name</th><th>Email</th><th>Actions</th></tr></thead>
              <tbody>
                <tr *ngFor="let student of selectedClass.students">
                  <td>
                    <div class="student-name">{{ student.name || 'N/A' }}</div>
                    <div class="student-email">{{ student.email }}</div>
                  </td>
                  <td>{{ student.email }}</td>
                  <td><button class="btn-table-danger" (click)="handleRemoveStudent(selectedClass.id, student)">Remove</button></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        <!-- Materials Tab -->
        <div *ngIf="activeContentTab === 'materials'">
          <div class="table-wrapper" *ngIf="selectedClass.materials.length > 0; else emptyContent">
            <table class="content-table">
              <thead><tr><th>File Name</th><th>Type</th><th>Actions</th></tr></thead>
              <tbody>
                <tr *ngFor="let material of selectedClass.materials">
                  <td>{{ material.displayName }}</td>
                  <td>{{ material.fileType }}</td>
                  <td><button class="btn-table-danger" (click)="handleUnassignMaterial(selectedClass.id, material)">Unassign</button></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        <!-- Activities Tab -->
        <div *ngIf="activeContentTab === 'activities'">
          <div class="table-wrapper" *ngIf="selectedClass.activities.length > 0; else emptyContent">
            <table class="content-table">
               <thead><tr><th>Title</th><th>Type</th><th>Actions</th></tr></thead>
              <tbody>
                <tr *ngFor="let activity of selectedClass.activities">
                  <td>{{ activity.title }}</td>
                  <td>{{ activity.type }}</td>
                  <td><button class="btn-table-danger" (click)="handleUnassignActivity(selectedClass.id, activity)">Unassign</button></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
       <ng-template #emptyContent>
          <div class="empty-state">
            <p>Nothing to see here. <br> Assign some content to get started.</p>
          </div>
        </ng-template>
    </ng-container>
    
    <!-- This now renders correctly when no class is selected -->
    <ng-template #noClassSelected>
      <div class="empty-state-large">
        <i class="fas fa-mouse-pointer"></i>
        <h2>Select a Class</h2>
        <p>Choose a class from the list to view its details.</p>
      </div>
    </ng-template>
  </div>
</div>

<!-- Modal for creating a new class -->
<div *ngIf="isCreateModalOpen" class="modal-overlay" (click)="closeCreateModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Create New Class</h3>
      <button class="btn-close" (click)="closeCreateModal()">&times;</button>
    </div>
    <div class="modal-body">
      <form #createClassForm="ngForm" (ngSubmit)="handleCreateClass()">
        <div class="input-group">
          <label for="newClassName">Class Name *</label>
          <input type="text" id="newClassName" [(ngModel)]="newClassName" name="newClassName" required>
        </div>
        <div class="input-group">
          <label for="newClassDescription">Description</label>
          <textarea id="newClassDescription" [(ngModel)]="newClassDescription" name="newClassDescription" rows="4"></textarea>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" (click)="closeCreateModal()">Cancel</button>
          <button type="submit" class="btn btn-primary" [disabled]="!newClassName.trim()">Create Class</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Universal Confirmation Modal -->
<div *ngIf="confirmModal.isOpen" class="modal-overlay" (click)="closeConfirmModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
            <h3>{{ confirmModal.title }}</h3>
            <button class="btn-close" (click)="closeConfirmModal()">&times;</button>
        </div>
        <div class="modal-body">
            <p [innerHTML]="confirmModal.message"></p>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" (click)="closeConfirmModal()">Cancel</button>
                <button type="button" class="btn btn-danger" (click)="confirmModal.onConfirm()">Confirm</button>
            </div>
        </div>
    </div>
</div>

<!-- THIS IS THE NEW TOAST NOTIFICATION -->
<div *ngIf="toast.isVisible" 
     class="toast" 
     [ngClass]="{'success': toast.type === 'success', 'error': toast.type === 'error'}">
  <i class="fas" [ngClass]="{'fa-check-circle': toast.type === 'success', 'fa-times-circle': toast.type === 'error'}"></i>
  {{ toast.message }}
</div>

